<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>The Geometry &mdash; SAXS 0.2.1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="SAXS 0.2.1 documentation" href="index.html" />
    <link rel="up" title="The Technology" href="TheTechnology.html" />
    <link rel="next" title="Polarization Correction" href="PolCorr.html" />
    <link rel="prev" title="Integration as Matrix-Vector Multiplication" href="MatrixMulti.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="PolCorr.html" title="Polarization Correction"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="MatrixMulti.html" title="Integration as Matrix-Vector Multiplication"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">SAXS 0.2.1 documentation</a> &raquo;</li>
          <li><a href="TheTechnology.html" accesskey="U">The Technology</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="the-geometry">
<span id="geometry"></span><h1>The Geometry<a class="headerlink" href="#the-geometry" title="Permalink to this headline">¶</a></h1>
<p>The plane of the sensor is not perfectly normal to the beam. So in order to calculate witch
pixel is on witch cone in the diffracted light, we need to express the geometry somehow.</p>
<p>Every pixel has the polar coordinates <span class="math">\(r\)</span>, <span class="math">\(\phi\)</span> with the projected diffraction center in the origin.
For each pixel (P) the triangle S,C,P (Sample, Center, Pixel, <span class="math">\(\theta\)</span>, <span class="math">\(\beta\)</span>, <span class="math">\(\gamma\)</span>)
can be fully expressed with the law of cosines.</p>
<div class="figure">
<img src="_images/Dreieck.svg" /><p class="caption">The SCP triangle.</p>
</div>
<p><span class="math">\(l\)</span> is the distance the light travels from the diffraction center to the sensor.</p>
<div class="math">
\[l^2=d^2+r^2 - 2 d r \cos(\pi/2+\alpha)\]</div>
<p><span class="math">\(r\)</span> is the radial coordinate of the pixel P.</p>
<div class="math">
\[r^2=l^2+d^2 -2 l d \cos(\theta)\]</div>
<p>from these two formulas the diffraction angle (here) <span class="math">\(\theta\)</span> can be computed.</p>
<div class="math">
\[\theta=\arccos(-r^2 -l^2 -d^2 2 l d)\]</div>
<div class="figure" id="alpha">
<img src="_images/winkel.svg" /><p class="caption">Angle between two planes.</p>
</div>
<p><span class="math">\(\alpha\)</span> comes from the following relation in figure <a class="reference internal" href="#alpha"><em>Angle between two planes.</em></a></p>
<p>The angle between the sensor plane and the normal plane to the ray is given by <span class="math">\(\tau\)</span>.
The slope <span class="math">\(s\)</span> derived from  <span class="math">\(\tau\)</span> is</p>
<div class="math">
\[s=\sin(\tau)\]</div>
<p>On the (red) unit circle in the plane of the sensor the distance to the plane normal to the ray is expressed as</p>
<div class="math">
\[h=\sin(\phi)s\]</div>
<p>The angle <span class="math">\(\alpha\)</span> is therefore:</p>
<div class="math">
\[\alpha=\arcsin(\sin(\tau)\sin(\phi))\]</div>
<p>in python code this is <a class="reference internal" href="SAXSapi.html#SAXS.calc_theta" title="SAXS.calc_theta"><tt class="xref py py-func docutils literal"><span class="pre">SAXS.calc_theta()</span></tt></a>:</p>
<div class="code highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">calc_theta</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">tilt</span><span class="p">,</span><span class="n">tiltdir</span><span class="p">):</span>
   <span class="n">alpha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tilt</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="o">+</span><span class="n">tiltdir</span><span class="p">))</span>
   <span class="n">lsquared</span><span class="o">=</span><span class="n">d</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">alpha</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">lsquared</span><span class="o">-</span><span class="n">d</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lsquared</span><span class="p">)</span><span class="o">*</span><span class="n">d</span><span class="p">))</span>
</pre></div>
</div>
<p>This angle <span class="math">\(\theta\)</span> then is calculated for every sub pixel in the sensor.
This number then can be rescaled and rounded to the nearest integer in order to get
unique integer labels for all the pixels. This labels are the index of the radial interval.</p>
<div class="section" id="tilt-angle-correction-test">
<h2>Tilt Angle Correction Test<a class="headerlink" href="#tilt-angle-correction-test" title="Permalink to this headline">¶</a></h2>
<p>To check if the tilt angle correction is working, lets create some fake calibration data, with the following peaks in the diffraction curve:</p>
<p>(<a class="reference external" href=".//Geometry-1.py">Source code</a>, <a class="reference external" href=".//Geometry-1.png">png</a>, <a class="reference external" href=".//Geometry-1.hires.png">hires.png</a>, <a class="reference external" href=".//Geometry-1.pdf">pdf</a>)</p>
<div class="figure">
<img alt="_images/Geometry-1.png" src="_images/Geometry-1.png" />
</div>
<p>(<a class="reference external" href=".//Geometry-2.py">Source code</a>, <a class="reference external" href=".//Geometry-2.png">png</a>, <a class="reference external" href=".//Geometry-2.hires.png">hires.png</a>, <a class="reference external" href=".//Geometry-2.pdf">pdf</a>)</p>
<div class="figure">
<img alt="_images/Geometry-2.png" src="_images/Geometry-2.png" />
</div>
<p>This was done with this configuration file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s">&quot;PixelPerRadialElement&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&quot;Imagesize&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="mi">1043</span><span class="p">,</span>
        <span class="mi">981</span>
    <span class="p">],</span>
    <span class="s">&quot;Tilt&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;TiltAngleDeg&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span>
        <span class="s">&quot;TiltRotDeg&quot;</span><span class="p">:</span> <span class="mf">73.569</span>
    <span class="p">},</span>
    <span class="s">&quot;MaskFile&quot;</span><span class="p">:</span> <span class="s">&quot;emptymask.tif&quot;</span><span class="p">,</span>
    <span class="s">&quot;PixelSizeMicroM&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="mf">172.0</span><span class="p">,</span>
        <span class="mf">172.0</span>
    <span class="p">],</span>
    <span class="s">&quot;Wavelength&quot;</span><span class="p">:</span> <span class="mf">1.54</span><span class="p">,</span>
    <span class="s">&quot;DedectorDistanceMM&quot;</span><span class="p">:</span> <span class="mf">1031.657</span><span class="p">,</span>
    <span class="s">&quot;BeamCenter&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="mf">808.37</span><span class="p">,</span>
        <span class="mf">387.772</span>
    <span class="p">],</span>
    <span class="s">&quot;Oversampling&quot;</span><span class="p">:</span> <span class="mi">2</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Which amounts to a large tilt, lets see what Fit2d makes of it</p>
<div class="code highlight-python"><div class="highlight"><pre>INFO: SOLUTION 2
INFO: Best fit beam centre (X/Y mm) =   66.78356      138.9544
INFO: Best fit beam centre (X/Y pixels) =   388.2765      807.8745
INFO: Cone  1 best fit 2 theta angle (degrees) =   1.392646
INFO: Cone  2 best fit 2 theta angle (degrees) =   2.780810
INFO: Cone  3 best fit 2 theta angle (degrees) =   4.168858
INFO: Cone  4 best fit 2 theta angle (degrees) =   5.556975
INFO: Cone  5 best fit 2 theta angle (degrees) =   6.944765
INFO: Best fit angle of tilt plane rotation (degrees) =   73.59509
INFO: Best fit angle of tilt (degrees) =  -10.00601
INFO: Estimated coordinate radial position error (mm) =  0.7136476E-02
INFO: Estimated coordinate radial position error (X pixels) =  0.4149114E-01
</pre></div>
</div>
<p>Seems OK.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The Geometry</a><ul>
<li><a class="reference internal" href="#tilt-angle-correction-test">Tilt Angle Correction Test</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="MatrixMulti.html"
                        title="previous chapter">Integration as Matrix-Vector Multiplication</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="PolCorr.html"
                        title="next chapter">Polarization Correction</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/Geometry.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="PolCorr.html" title="Polarization Correction"
             >next</a> |</li>
        <li class="right" >
          <a href="MatrixMulti.html" title="Integration as Matrix-Vector Multiplication"
             >previous</a> |</li>
        <li><a href="index.html">SAXS 0.2.1 documentation</a> &raquo;</li>
          <li><a href="TheTechnology.html" >The Technology</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Christian Meisenbichler.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>